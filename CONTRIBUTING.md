# Contributing to PulumiCost MCP Server

Thank you for your interest in contributing to PulumiCost MCP Server! This document provides guidelines and instructions for contributing.

## Code of Conduct

This project adheres to a Code of Conduct (see CODE_OF_CONDUCT.md). By participating, you are expected to uphold this code.

## Getting Started

### Prerequisites

- Go 1.24 or later
- Make
- Git
- Pulumi CLI (for testing)
- Docker (optional, for containerized testing)

### Development Setup

1. **Fork and clone the repository**

   ```bash
   git clone git@github.com:YOUR_USERNAME/pulumicost-mcp.git
   cd pulumicost-mcp
   ```

2. **Set up your development environment**

   ```bash
   make setup
   ```

   This will:
   - Install required development tools
   - Download dependencies
   - Generate initial code from Goa design

3. **Verify your setup**

   ```bash
   make validate
   ```

## Development Workflow

### Design-First Development

This project uses Goa for design-first API development. **All API changes must start in the design files.**

1. **Modify design files** in `design/`
2. **Regenerate code**: `make generate`
3. **Implement service logic** in `internal/service/`
4. **Write tests**
5. **Run validation**: `make validate`

### Never Modify Generated Code

Files in `gen/` are generated by Goa. **Never edit these files directly.** All changes must flow through the design files.

### Code Style

- Follow standard Go conventions
- Use `gofmt` for formatting (run via `make fmt`)
- Follow the [Uber Go Style Guide](https://github.com/uber-go/guide/blob/master/style.md)
- Use meaningful variable names
- Add comments for exported functions and types
- Keep functions focused and small

### Commit Messages

Use conventional commit format:

```
type(scope): subject

body

footer
```

**Types:**
- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation changes
- `style`: Code style changes (formatting, etc.)
- `refactor`: Code refactoring
- `test`: Test additions or changes
- `chore`: Build process or tooling changes

**Examples:**

```
feat(cost): add streaming support for large stack analysis

Implements server-side streaming for AnalyzeStack method to provide
progress updates when analyzing stacks with many resources.

Closes #42
```

```
fix(plugin): handle connection timeout gracefully

Added circuit breaker pattern to prevent cascading failures when
plugins are unresponsive.

Fixes #67
```

### Branch Naming

- `feature/issue-number-short-description` - New features
- `fix/issue-number-short-description` - Bug fixes
- `docs/short-description` - Documentation updates
- `refactor/short-description` - Code refactoring

## Making Changes

### 1. Create an Issue

Before starting work, create an issue describing:
- The problem or feature
- Proposed solution
- Any relevant context

For bugs, include:
- Steps to reproduce
- Expected behavior
- Actual behavior
- Environment details

### 2. Create a Branch

```bash
git checkout -b feature/123-add-caching
```

### 3. Make Changes

Follow the development workflow above. Ensure:
- Code follows style guidelines
- All tests pass: `make test`
- Linting passes: `make lint`
- Code is well-documented

### 4. Write Tests

- **Unit tests**: For service and adapter logic
- **Integration tests**: For cross-layer interactions
- **E2E tests**: For complete user workflows

Aim for >80% test coverage:

```bash
make test-coverage
```

### 5. Update Documentation

Update relevant documentation:
- Code comments
- README.md (if user-facing changes)
- API documentation (if API changes)
- CLAUDE.md (if new patterns or conventions)

### 6. Commit Changes

```bash
git add .
git commit -m "feat(cost): add response caching"
```

### 7. Push and Create PR

```bash
git push origin feature/123-add-caching
```

Create a Pull Request on GitHub with:
- Clear title following commit message format
- Description of changes
- Link to related issue(s)
- Screenshots/examples if applicable
- Checklist of completed items

## Pull Request Guidelines

### PR Template

Your PR should include:

- **Description**: What does this PR do?
- **Motivation**: Why is this change needed?
- **Related Issues**: Fixes #123, Relates to #456
- **Type of Change**: Feature, Bug Fix, Documentation, etc.
- **Testing**: How was this tested?
- **Checklist**:
  - [ ] Design files updated (if API changes)
  - [ ] Code generated: `make generate`
  - [ ] Tests written and passing
  - [ ] Linting passes: `make lint`
  - [ ] Documentation updated
  - [ ] Changelog updated (for user-facing changes)

### Review Process

1. **Automated Checks**: CI must pass (tests, linting, generation verification)
2. **Code Review**: At least one maintainer approval required
3. **Testing**: Verify changes work as intended
4. **Documentation**: Ensure docs are clear and complete

### Addressing Feedback

- Respond to all review comments
- Push additional commits to address feedback
- Request re-review when ready
- Be patient and collaborative

## Testing

### Running Tests

```bash
# Unit tests
make test

# Integration tests
make test-integration

# All tests
make test-all

# With coverage
make test-coverage
```

### Writing Tests

**Unit Test Example:**

```go
func TestCostService_GetProjectedCost(t *testing.T) {
    ctrl := gomock.NewController(t)
    defer ctrl.Finish()

    mockAdapter := adapter.NewMockPulumiCostAdapter(ctrl)
    svc := service.NewCostService(mockAdapter, nil, nil, logger)

    mockAdapter.EXPECT().
        GetProjectedCost(gomock.Any(), gomock.Any()).
        Return(&adapter.CostResult{TotalCost: 100.0}, nil)

    result, err := svc.GetProjectedCost(context.Background(), payload)

    require.NoError(t, err)
    assert.Equal(t, 100.0, result.TotalCost)
}
```

### Test Coverage Requirements

- Minimum 80% coverage for new code
- All exported functions must have tests
- Test both success and error paths
- Include edge cases

## Plugin Development

### Creating a Cost Source Plugin

1. Implement the pulumicost-spec gRPC interface
2. Follow the plugin developer guide in `role-prompts/plugin-developer.md`
3. Run conformance tests: `make validate-plugin`
4. Submit PR with plugin code and documentation

### Plugin Submission

Include in your PR:
- Plugin implementation
- README with setup instructions
- Example queries
- Conformance test results

## Documentation

### Types of Documentation

- **Code Comments**: For developers reading code
- **API Documentation**: Generated from Goa design
- **User Guides**: In `docs/` for end users
- **Developer Guides**: In `docs/development/` for contributors
- **Role Prompts**: AI assistant context in `role-prompts/`

### Documentation Style

- Use clear, concise language
- Include code examples
- Add diagrams where helpful
- Keep docs up to date with code changes

## Release Process

Releases are managed by maintainers. Contributors should:

1. Ensure changes are merged to `main`
2. Update CHANGELOG.md if user-facing
3. Tag issues with appropriate milestone

Maintainers will:
1. Create release branch
2. Update version numbers
3. Build release artifacts
4. Create GitHub release
5. Publish Docker images
6. Update Homebrew formula

## Questions?

- **GitHub Discussions**: For general questions
- **GitHub Issues**: For bugs and feature requests
- **Discord**: [Join our community](https://discord.gg/pulumicost) (if available)

## License

By contributing, you agree that your contributions will be licensed under the same license as the project (see LICENSE file).

## Recognition

Contributors will be recognized in:
- CONTRIBUTORS.md file
- Release notes
- Project README

Thank you for contributing to PulumiCost MCP Server!
